<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Erzbergrodeo Speaker Dashboard</title>
    <style>
      body {
        font-family: sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 20px;
      }
      h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }
      table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 30px;
  font-family: sans-serif;
  font-size: 14px;
}

.table-container {
  max-height: calc(10 * 41px);
  overflow-y: auto;

  /* Hide scrollbar (cross-browser) */
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none;  /* IE and Edge */
}

.table-container::-webkit-scrollbar {
  display: none;  /* Chrome, Safari, Opera */
}

#leaderboard {
  margin: auto;
  width: 90%;
}


th,
td {
  padding: 10px 14px;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
}

th {
  background: #222;
  color: white;
  position: sticky;
  top: 0;
  z-index: 1;
}

/* Zebra striping */
tbody tr:nth-child(odd) {
  background-color: #f9fafb;
}

tbody tr:nth-child(even) {
  background-color: #ffffff;
}

/* Hover effect */
tbody tr:hover {
  background-color: #f3f4f6;
}

/* Highlighted row */
.highlight {
  background: #d1fae5 !important;
}


      .cp-table td {
        text-align: center;
      }

      .badge {
        font-size: 1em;
        background: #4ade80;
        color: #222;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 4px;
      }

.responsive-cp {
  max-width: 100%;
  padding: 0 10px;
}

.responsive-cp-grid-wrapper {
  display: flex;
  justify-content: center;
}

.responsive-cp-grid {
  display: grid;
  grid-auto-flow: row;
  grid-template-columns: repeat(auto-fill, 62px);
  justify-content: start;
  gap: 10px;
  max-width: calc(62px * 10 + 10px * 9); /* 10 items + 9 gaps */
}

#checkpointRidersContainer {
  background-color: #fff;
  border-radius: 8px;
  padding: 15px 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  max-width: 90vw;
  margin: 20px auto 0 auto;
  width: fit-content;
  overflow-y: auto;
  max-height: 400px;

  /* Hide scrollbar for WebKit browsers (Chrome, Safari, Edge) */
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none;  /* IE and Edge */
}

#checkpointRidersContainer::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Opera */
}

      .cp-item {
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 3px;
        text-align: center;
        font-size: 1em;
        width: 62px;
      }

      .cp-label {
        font-weight: bold;
        font-size: 1em;
        color: #f7f7f7;
        background-color: #111;
        padding-top: 3px;
      }

      .cp-label-rider {
        font-weight: bold;
        font-size: 0.7em;
        color: #f7f7f7;
        background-color: #A81815;
        padding-top: 3px;
        padding-bottom: 3px;
      }

      .cp-value {
        margin-top: 4px;
        font-size: 1.3em;
        color: #111;
      }

      .progress-wrapper {
  background: #e5e7eb;
  border-radius: 4px;
  position: relative;
  height: 18px;
  width: 100%;
  max-width: 300px;
  overflow: hidden;
}

.progress-bar {
  background: #4ade80;
  height: 100%;
  transition: width 0.3s ease;
}

.progress-label {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  line-height: 16px;
  color: #111;
  font-weight: bold;
}

h3 {
  position: sticky;
  top: -15px;
  background: white; /* or the background color of your container */
  z-index: 10; /* keep it above other content */
  padding: 10px 0; /* optional spacing */
  border-bottom: 1px solid #ccc; /* optional visual separation */
}


    </style>
  </head>
  <body>
    <h1>üèÅ Erzbergrodeo Dashboard</h1>

    <section>
      <h2 style="text-align: center;">Top 20 Riders (by total time)</h2>
      <div class="table-container">
        <table id="leaderboard">
          <thead>
            <tr>
              <th>Pos</th>
              <th>Bib</th>
              <th>Name</th>
              <th>Time</th>
              <th>Progress</th>
              <th>Current CP</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section>
      <h2 style="text-align: center;">Checkpoint Counts</h2>
      <div class="responsive-cp" style="margin-left: auto; margin-right: auto; width: fit-content;">
  <div class="responsive-cp-grid-wrapper">
    <div class="responsive-cp-grid" id="checkpointStatsGrid">
      <!-- JavaScript will populate this -->
    </div>
  </div>
</div>
    </section>

    <section>
  <h2 style="text-align: center;">Riders per Checkpoint</h2>
  <div id="checkpointRidersContainer" class="responsive-cp">
    <!-- JavaScript will populate this -->
  </div>
</section>

    <script>
      const API_URL =
        "https://api.raceresult.com/341508/MRZHEBCS0R2X3WGCZLWHDFS46SLBA7FD";

      async function fetchData() {
        const res = await fetch(API_URL);
        const data = await res.json();
        return data;
      }

      function dToMs(t) {
        const parts = t.split(":");
        if (parts.length < 3) return Infinity;
        const [h, m, s] = parts;
        return +h * 3600 + +m * 60 + parseFloat(s.replace(",", "."));
      }

      function updateLeaderboard(data) {
        const tbody = document.querySelector("#leaderboard tbody");
        tbody.innerHTML = "";

        data.forEach((r) => {
          r.lastCPNum = 0;
          for (let i = 27; i >= 1; i--) {
            if (r["CP" + i]) {
              r.lastCPNum = i;
              break;
            }
          }
        });

        const getBarColor = (percent) => {
  if (percent >= 100) return '#22c55e'; // green-500 ‚Üí ‚úÖ "complete"
  if (percent >= 80)  return '#84cc16'; // lime-500 ‚Üí strong greenish-yellow
  if (percent >= 60)  return '#facc15'; // yellow-400 ‚Üí ‚ö†Ô∏è "decent progress"
  if (percent >= 40)  return '#fb923c'; // orange-400 ‚Üí üü† "halfway"
  if (percent >= 20)  return '#f87171'; // red-400 ‚Üí üî¥ "early"
  return '#ef4444';                     // red-500 ‚Üí ‚ùó "just started"
};

        const sorted = data
          .filter((r) => r.lastCPNum > 0)
          .sort((a, b) => {
            if (b.lastCPNum !== a.lastCPNum) return b.lastCPNum - a.lastCPNum;
            return dToMs(a.ERZ_Time) - dToMs(b.ERZ_Time);
          })
          .slice(0, 50);

        sorted.forEach((r, i) => {
          const tr = document.createElement("tr");
          const percent = Math.round((r.lastCPNum / 27) * 100);
          tr.innerHTML = `
  <td>${i + 1}</td>
  <td>${r.ERZ_Number}</td>
  <td>${r.DisplayNameERZ}</td>
  <td>${r.ERZ_Time || "-"}</td>
  <td>
    <div class="progress-wrapper">
      <div class="progress-bar" style="width: ${percent}%; background: ${getBarColor(percent)};"></div>
      <div class="progress-label">${percent}%</div>
    </div>
  </td>
  <td><span class="badge">CP${r.lastCPNum}</span> - ${r.CheckpointName}</td>
`;
          tbody.appendChild(tr);
        });
      }

      function updateCheckpointStats(data) {
        const container = document.getElementById("checkpointStatsGrid");
        container.innerHTML = "";

        const counts = Array(27).fill(0);
        data.forEach((r) => {
          for (let i = 1; i <= 27; i++) {
            if (r["CP" + i]) counts[i - 1]++;
          }
        });

        for (let i = 1; i <= 27; i++) {
          const div = document.createElement("div");
          div.className = "cp-item";
          div.innerHTML = `
            <div class="cp-label">CP${i}</div>
            <div class="cp-value">${counts[i - 1]}</div>
          `;
          container.appendChild(div);
        }
      }

      function updateCheckpointRiders(data) {
  const container = document.getElementById("checkpointRidersContainer");
  container.innerHTML = "";

  const cpMap = {};

  data.forEach((r) => {
    let lastCP = 0;
    let name = "";
    for (let i = 27; i >= 1; i--) {
      if (r["CP" + i]) {
        lastCP = i;
        name = r.CheckpointName || "";
        break;
      }
    }

    if (!lastCP) return;

    if (!cpMap[lastCP]) cpMap[lastCP] = { name, riders: [] };
    cpMap[lastCP].riders.push(r.ERZ_Number);
  });

  // Sort CPs descending
  const sortedCPs = Object.keys(cpMap).sort((a, b) => b - a);

  sortedCPs.forEach((cpNum) => {
    const { name, riders } = cpMap[cpNum];
    const section = document.createElement("div");
    section.style.marginBottom = "20px";

    const title = document.createElement("h3");
title.style.textAlign = "center";
title.textContent = `CP${cpNum} - ${name} (Count: ${riders.length})`;
section.appendChild(title);

    const gridWrapper = document.createElement("div");
    gridWrapper.className = "responsive-cp-grid-wrapper";

    const grid = document.createElement("div");
    grid.className = "responsive-cp-grid";

    riders.forEach((number) => {
      const item = document.createElement("div");
      item.className = "cp-item";
      item.innerHTML = `
        <div class="cp-label-rider">RIDER</div>
        <div class="cp-value">${number}</div>
      `;
      grid.appendChild(item);
    });

    gridWrapper.appendChild(grid);
    section.appendChild(gridWrapper);
    container.appendChild(section);
  });
}


      async function loadDashboard() {
        const data = await fetchData();
        updateLeaderboard(data);
        updateCheckpointStats(data);
        updateCheckpointRiders(data);
      }

      loadDashboard();
      setInterval(loadDashboard, 3000);
    </script>
  </body>
</html>
